<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- [ë³´ì•ˆ ì •ì±… ìˆ˜ì •] img-srcì™€ connect-srcë¥¼ 'https:'ë¡œ ë„“í˜€ì„œ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì°¨ë‹¨ ë¬¸ì œ í•´ê²° -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: https:; 
        connect-src 'self' https:;
    ">

    <!-- SEO Meta Tags -->
    <title>RichFolio | ETF ìˆ˜ìµë¥  ê³„ì‚°ê¸° & ì‹œë®¬ë ˆì´í„°</title>
    <meta name="description" content="ë¯¸êµ­/í•œêµ­ ETF ì ë¦½ì‹ íˆ¬ì ì‹œë®¬ë ˆì´í„°. ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™, ISA ê³„ì¢Œ êµ¬ë¶„, ë°°ë‹¹ ì¬íˆ¬ì ë³µë¦¬ ê³„ì‚°, PDF ë¦¬í¬íŠ¸ ì œê³µ.">
    <meta name="keywords" content="ETF ì‹œë®¬ë ˆì´í„°, ë³µë¦¬ ê³„ì‚°ê¸°, ë¯¸êµ­ì£¼ì‹, ISA, ì ë¦½ì‹ íˆ¬ì, ë°°ë‹¹ê¸ˆ ì¬íˆ¬ì, SCHD, QQQ, TIGER ë¯¸êµ­í…Œí¬TOP10">
    <meta property="og:title" content="RichFolio - ë‚´ ìì‚°ì˜ ë¯¸ë˜ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ì„¸ìš”">
    <meta property="og:description" content="í´ë¦­ ëª‡ ë²ˆìœ¼ë¡œ 10ë…„ ë’¤ ìì‚°ì„ í™•ì¸í•˜ì„¸ìš”. ë³´ì•ˆ ê°•í™”ëœ ì›¹ì•±ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.">
    <meta property="og:url" content="https://grid-worker.github.io/etf-sim/">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; -webkit-font-smoothing: antialiased; }
        
        .secure-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .secure-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .secure-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 secure-scroll" onclick="uiManager.closeSuggestions()">

    <!-- í—¤ë” -->
    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 md:py-4 flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ“ˆ</span>
                <h1 class="text-lg md:text-xl font-bold text-slate-800">RichFolio</h1>
                <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold ml-1 border border-green-200">Secure</span>
                
                <!-- [Global Visitor Counter] -->
                <div class="ml-2 pt-1 flex items-center" title="ëˆ„ì  ë°©ë¬¸ì ìˆ˜">
                    <a href="https://hits.seeyoufarm.com">
                        <!-- onerror ì¶”ê°€: ì´ë¯¸ì§€ê°€ ê¹¨ì§€ë©´ ìˆ¨ê¹€ ì²˜ë¦¬í•˜ì—¬ ì—‘ë°• ì•„ì´ì½˜ ë°©ì§€ -->
                        <img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fgrid-worker.github.io%2Fetf-sim%2F&count_bg=%234F46E5&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=false" 
                             alt="hits" 
                             style="min-height: 20px;"
                             onerror="this.style.display='none'"/>
                    </a>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="dataManager.exportData()" class="flex items-center gap-1 bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg text-xs md:text-sm hover:bg-slate-50 transition">
                    ğŸ“¤ ë°±ì—…
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-1 bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg text-xs md:text-sm hover:bg-slate-50 transition">
                    ğŸ“¥ ë³µì›
                </button>
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="dataManager.importData(this)">
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- ì¢Œì¸¡ íŒ¨ë„ -->
        <div class="col-span-1 lg:col-span-4 space-y-6 order-2 lg:order-1">
            
            <!-- ì¢…ëª© ê²€ìƒ‰ -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative z-40">
                <h2 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    ğŸ” ì¢…ëª© ê²€ìƒ‰ <span class="text-xs font-normal text-slate-400">(XSS Filtered)</span>
                </h2>
                
                <div class="relative">
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="tickerInput" 
                            class="flex-1 p-3 border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 uppercase text-sm" 
                            placeholder="ì˜ˆ: 360750, AAPL" autocomplete="off">
                        <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 rounded-lg font-bold text-sm transition">ì¶”ê°€</button>
                    </div>
                    <!-- ìë™ì™„ì„± ë°•ìŠ¤ -->
                    <div id="suggestionBox" class="hidden absolute top-full left-0 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-52 overflow-y-auto mt-1 z-50 secure-scroll"></div>
                </div>

                <div class="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded-lg">
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>í•œêµ­ ETF:</strong> 6ìë¦¬ ì½”ë“œ(360750) ì…ë ¥ ì‹œ ì •í™•ë„ UP</li>
                        <li><strong>ë¯¸êµ­ ETF:</strong> í‹°ì»¤(QQQ, SPY) ì…ë ¥</li>
                    </ul>
                </div>

                <!-- í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤íŠ¸ -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-sm text-slate-700">í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘</span>
                        <span id="totalAlloc" class="text-xs font-bold text-white bg-slate-300 px-2 py-0.5 rounded-full">0%</span>
                    </div>
                    
                    <div id="portfolioList" class="space-y-2 max-h-[300px] overflow-y-auto pr-1 secure-scroll min-h-[50px]">
                        <!-- JSë¡œ ì•ˆì „í•˜ê²Œ ë Œë”ë§ë¨ -->
                    </div>
                    
                    <div id="emptyMsg" class="text-center text-xs text-slate-400 py-6 border-2 border-dashed border-slate-200 rounded-lg mt-2">
                        í¬íŠ¸í´ë¦¬ì˜¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <!-- ì„¤ì • íŒ¨ë„ -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-slate-800 mb-4">âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</h2>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-1">ì›” íˆ¬ìê¸ˆ</label>
                    <input type="text" id="inputAmount" class="w-full p-2 border border-slate-300 rounded text-right font-bold focus:border-blue-500 outline-none" value="1,000,000">
                    <div id="koreanMoney" class="text-xs text-blue-600 text-right mt-1">ì¼ë°±ë§Œ ì›</div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-1">ê¸°ê°„: <span id="yearVal" class="text-blue-600">10ë…„</span></label>
                    <input type="range" id="inputYears" min="1" max="30" value="10" class="w-full accent-blue-600 cursor-pointer">
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-slate-700">ë°°ë‹¹ê¸ˆ ì¬íˆ¬ì</span>
                    <input type="checkbox" id="reinvest" class="w-5 h-5 accent-blue-600" checked>
                </div>
            </div>

            <button onclick="simulationManager.run()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2">
                <span>ğŸš€</span> ê³„ì‚° ì‹¤í–‰í•˜ê¸°
            </button>
        </div>

        <!-- ìš°ì¸¡ íŒ¨ë„ (ê²°ê³¼) -->
        <div class="col-span-1 lg:col-span-8 space-y-6 order-1 lg:order-2" id="reportArea">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-slate-800">ğŸ“Š ë¶„ì„ ë¦¬í¬íŠ¸</h2>
                <div class="flex gap-2" data-html2canvas-ignore="true">
                    <button onclick="uiManager.downloadReport('image')" class="bg-white border text-slate-600 px-3 py-1 rounded text-xs hover:bg-slate-50">IMG</button>
                    <button onclick="uiManager.downloadReport('pdf')" class="bg-slate-700 text-white px-3 py-1 rounded text-xs hover:bg-slate-800">PDF</button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-xl border-l-4 border-slate-400 shadow-sm">
                    <p class="text-xs text-slate-500">ì´ ì›ê¸ˆ</p>
                    <p id="resPrincipal" class="text-xl font-bold text-slate-700 mt-1">0ì›</p>
                </div>
                <div class="bg-white p-5 rounded-xl border-l-4 border-green-500 shadow-sm">
                    <p class="text-xs text-slate-500">ëˆ„ì  ë°°ë‹¹ê¸ˆ</p>
                    <p id="resDividend" class="text-xl font-bold text-green-600 mt-1">0ì›</p>
                </div>
                <div class="bg-white p-5 rounded-xl border-l-4 border-blue-600 shadow-sm">
                    <p class="text-xs text-slate-500">ìµœì¢… í‰ê°€ì•¡</p>
                    <p id="resFinal" class="text-xl font-bold text-blue-600 mt-1">0ì›</p>
                    <p id="resRoi" class="text-xs font-bold text-blue-400 mt-1">+0%</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-80 relative">
                 <canvas id="chart"></canvas>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm overflow-hidden">
                <h3 class="font-bold text-slate-700 mb-4 text-sm">ë³´ìœ  ì¢…ëª© ìƒì„¸</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500 whitespace-nowrap">
                        <thead class="bg-slate-100 text-xs uppercase">
                            <tr>
                                <th class="px-4 py-2 rounded-l-lg">ì¢…ëª©ëª…</th>
                                <th class="px-4 py-2">í˜„ì¬ê°€</th>
                                <th class="px-4 py-2">ê³„ì¢Œ</th>
                                <th class="px-4 py-2 text-right">ì„±ì¥ë¥ (5Y)</th>
                                <th class="px-4 py-2 text-right">ë°°ë‹¹ë¥ </th>
                                <th class="px-4 py-2 rounded-r-lg text-center" data-html2canvas-ignore="true">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- [AD] í•˜ë‹¨ ê´‘ê³  ì˜ì—­ -->
            <div class="ad-area w-full h-24 rounded-lg mt-4 bg-slate-100 flex items-center justify-center text-slate-400 text-sm border-2 border-dashed border-slate-200" data-html2canvas-ignore="true">
                Google AdSense Area
            </div>

            <div class="text-center text-xs text-slate-400 mt-4 pb-4">
                * ë³¸ ì„œë¹„ìŠ¤ëŠ” í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ í‘œì¤€ì„ ì¤€ìˆ˜í•˜ë©° ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
        </div>
    </main>

    <!-- ë¡œë”© ëª¨ë‹¬ -->
    <div id="loading" class="hidden fixed inset-0 bg-slate-900/50 z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl flex flex-col items-center shadow-2xl">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div>
            <p class="font-bold text-slate-700" id="loadingText">ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast" class="hidden fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg text-sm z-[70] transition-opacity duration-300 opacity-0"></div>

    <script>
        /**
         * ğŸ›¡ï¸ ë³´ì•ˆ ìœ í‹¸ë¦¬í‹° (Security Utilities)
         */
        const Security = {
            sanitize: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            onlyNumber: (str) => String(str).replace(/[^0-9]/g, ''),
            safeTicker: (str) => String(str).replace(/[^A-Z0-9.]/g, '').toUpperCase(),
            validateImportData: (data) => {
                if (!data || typeof data !== 'object') return false;
                if (!Array.isArray(data.portfolio)) return false;
                if (!data.settings || typeof data.settings !== 'object') return false;
                return data.portfolio.every(item => 
                    typeof item.ticker === 'string' && 
                    typeof item.price === 'number' &&
                    typeof item.allocation === 'number'
                );
            }
        };

        // --- ì „ì—­ ìƒíƒœ ---
        const AppState = {
            portfolio: [],
            chartInstance: null,
            proxyBase: "https://corsproxy.io/?", 
            storageKey: "richfolio_v1"
        };

        /**
         * âš™ï¸ ë°ì´í„° ë§¤ë‹ˆì €
         */
        const dataManager = {
            save: () => {
                const payload = {
                    portfolio: AppState.portfolio,
                    settings: {
                        amount: Security.sanitize(document.getElementById('inputAmount').value),
                        years: document.getElementById('inputYears').value,
                        reinvest: document.getElementById('reinvest').checked
                    },
                    ts: Date.now()
                };
                localStorage.setItem(AppState.storageKey, JSON.stringify(payload));
            },
            load: () => {
                const raw = localStorage.getItem(AppState.storageKey);
                if (!raw) return;
                try {
                    const data = JSON.parse(raw);
                    if (Security.validateImportData(data)) {
                        AppState.portfolio = data.portfolio;
                        document.getElementById('inputAmount').value = data.settings.amount;
                        document.getElementById('inputYears').value = data.settings.years;
                        document.getElementById('reinvest').checked = data.settings.reinvest;
                        uiManager.updateAll();
                    }
                } catch (e) { console.error("Data integrity check failed", e); }
            },
            exportData: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem(AppState.storageKey));
                const anchor = document.createElement('a');
                anchor.href = dataStr;
                anchor.download = `RichFolio_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
                uiManager.showToast("ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.");
            },
            importData: (input) => {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if (!Security.validateImportData(parsed)) throw new Error("Invalid Format");
                        
                        AppState.portfolio = parsed.portfolio;
                        document.getElementById('inputAmount').value = Security.sanitize(parsed.settings.amount);
                        document.getElementById('inputYears').value = parsed.settings.years;
                        document.getElementById('reinvest').checked = parsed.settings.reinvest;
                        
                        dataManager.save();
                        uiManager.updateAll();
                        uiManager.showToast("ë³µì› ì™„ë£Œ! ë°ì´í„° ê²€ì¦ í†µê³¼.");
                        setTimeout(() => simulationManager.run(), 500);
                    } catch (err) {
                        alert("íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë³€ì¡°ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                };
                reader.readAsText(file);
                input.value = '';
            }
        };

        /**
         * ğŸ¨ UI ë§¤ë‹ˆì €
         */
        const uiManager = {
            formatMoney: (n) => Math.round(n).toLocaleString() + 'ì›',
            numToKor: (num) => {
                if(num===0) return "0ì›";
                const units = ["", "ë§Œ", "ì–µ", "ì¡°"];
                let result = [];
                let unitIdx = 0;
                while(num > 0) {
                    let mod = num % 10000;
                    if(mod > 0) result.unshift(mod.toLocaleString() + units[unitIdx]);
                    num = Math.floor(num / 10000);
                    unitIdx++;
                }
                return result.join(' ') + " ì›";
            },
            
            updateAll: () => {
                uiManager.renderPortfolio();
                uiManager.renderTable();
                
                const amtVal = Security.onlyNumber(document.getElementById('inputAmount').value);
                document.getElementById('koreanMoney').textContent = uiManager.numToKor(Number(amtVal));
                document.getElementById('yearVal').textContent = document.getElementById('inputYears').value + "ë…„";
                
                const total = AppState.portfolio.reduce((sum, i) => sum + (i.allocation||0), 0);
                const allocBadge = document.getElementById('totalAlloc');
                allocBadge.textContent = total + '%';
                allocBadge.className = `text-xs font-bold px-2 py-0.5 rounded-full ${total === 100 ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
                
                document.getElementById('emptyMsg').style.display = AppState.portfolio.length === 0 ? 'block' : 'none';
            },

            renderPortfolio: () => {
                const list = document.getElementById('portfolioList');
                list.innerHTML = ''; 

                AppState.portfolio.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-2 bg-slate-50 p-3 rounded-lg border border-slate-200 shadow-sm fade-in";
                    
                    const isaSpan = document.createElement('span');
                    isaSpan.className = item.isIsa 
                        ? "text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded border border-green-200 ml-1" 
                        : "text-[10px] bg-slate-200 text-slate-500 px-1.5 py-0.5 rounded ml-1";
                    isaSpan.textContent = item.isIsa ? "ISA" : "ì§íˆ¬";

                    div.innerHTML = `
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center gap-1 mb-1">
                                <span class="font-bold text-slate-800 text-sm">${Security.sanitize(item.ticker)}</span>
                            </div>
                            <div class="text-[10px] text-slate-500">
                                ì„±ì¥ <span class="text-blue-600 font-bold">${item.cagr}%</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <input type="number" class="w-14 p-1 text-right text-sm border border-slate-300 rounded focus:border-blue-500 outline-none font-bold" 
                                value="${item.allocation}" min="0" max="100">
                            <span class="text-xs text-slate-500">%</span>
                        </div>
                        <button class="text-slate-400 hover:text-red-500 p-1">Ã—</button>
                    `;

                    div.querySelector('div > div').appendChild(isaSpan); 
                    
                    const input = div.querySelector('input');
                    input.onchange = (e) => {
                        let val = parseInt(e.target.value) || 0;
                        if(val < 0) val = 0; if(val > 100) val = 100;
                        AppState.portfolio[idx].allocation = val;
                        uiManager.updateAll();
                        dataManager.save();
                    };

                    const btn = div.querySelector('button');
                    btn.onclick = () => {
                        AppState.portfolio.splice(idx, 1);
                        uiManager.updateAll();
                        dataManager.save();
                    };

                    list.appendChild(div);
                });
            },

            renderTable: () => {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';

                AppState.portfolio.forEach((item, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-slate-50 transition-colors";
                    
                    const currency = item.currency === 'KRW' ? 'â‚©' : '$';
                    const isaTxt = item.isIsa ? "ISAê°€ëŠ¥" : "í•´ì™¸ì§íˆ¬";
                    const isaClass = item.isIsa ? "text-green-600 bg-green-50" : "text-slate-500 bg-slate-100";

                    const addCell = (html, classes="") => {
                        const td = document.createElement('td');
                        td.className = "px-4 py-3 " + classes;
                        td.innerHTML = html; 
                        tr.appendChild(td);
                    };

                    addCell(`<span class="font-bold text-slate-700">${Security.sanitize(item.ticker)}</span>`);
                    addCell(`${currency}${item.price.toLocaleString()}`);
                    addCell(`<span class="px-2 py-1 rounded text-xs font-bold ${isaClass}">${isaTxt}</span>`, "text-center");
                    addCell(`<span class="text-blue-600 font-bold">${item.cagr}%</span>`, "text-right");
                    addCell(`<span class="text-green-600 font-bold">${item.yield}%</span>`, "text-right");
                    
                    const btnTd = document.createElement('td');
                    btnTd.className = "px-4 py-3 text-center";
                    btnTd.setAttribute("data-html2canvas-ignore", "true");
                    const btn = document.createElement('button');
                    btn.className = "text-xs bg-white border border-red-200 text-red-500 px-2 py-1 rounded hover:bg-red-50";
                    btn.textContent = "ì‚­ì œ";
                    btn.onclick = () => {
                        AppState.portfolio.splice(idx, 1);
                        uiManager.updateAll();
                        dataManager.save();
                    };
                    btnTd.appendChild(btn);
                    tr.appendChild(btnTd);

                    tbody.appendChild(tr);
                });
            },

            showToast: (msg) => {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.remove('opacity-0'), 10);
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, 3000);
            },

            toggleLoading: (show, text) => {
                const el = document.getElementById('loading');
                if(show) {
                    document.getElementById('loadingText').textContent = text;
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            },

            closeSuggestions: () => {
                setTimeout(() => document.getElementById('suggestionBox').classList.add('hidden'), 200);
            },

            downloadReport: async (type) => {
                uiManager.toggleLoading(true, "ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...");
                const element = document.getElementById('reportArea');
                try {
                    const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const fileName = `RichFolio_Report_${Date.now()}`;

                    if (type === 'image') {
                        const link = document.createElement('a');
                        link.href = imgData;
                        link.download = fileName + '.png';
                        link.click();
                    } else {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const w = 210, h = 297;
                        const imgH = canvas.height * w / canvas.width;
                        let heightLeft = imgH, pos = 0;
                        
                        pdf.addImage(imgData, 'PNG', 0, pos, w, imgH);
                        heightLeft -= h;
                        while(heightLeft >= 0) {
                            pos = heightLeft - imgH;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, pos, w, imgH);
                            heightLeft -= h;
                        }
                        pdf.save(fileName + '.pdf');
                    }
                } catch(e) { alert("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜"); } 
                finally { uiManager.toggleLoading(false); }
            }
        };

        /**
         * ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ë§¤ë‹ˆì €
         */
        const networkManager = {
            fetch: async (url) => {
                try {
                    const res = await fetch(AppState.proxyBase + encodeURIComponent(url));
                    if (!res.ok) throw new Error("Network Error");
                    return await res.json();
                } catch (e) {
                    console.error("Fetch Error:", e);
                    return null;
                }
            },
            
            getChartData: async (ticker) => {
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1mo&range=5y`;
                const data = await networkManager.fetch(url);
                return data?.chart?.result?.[0] || null;
            },

            searchSymbol: async (query) => {
                const url = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=6`;
                const data = await networkManager.fetch(url);
                return data?.quotes || [];
            }
        };

        /**
         * ğŸ§  ë¡œì§ ë§¤ë‹ˆì €
         */
        const logicManager = {
            addTicker: async (inputQuery) => {
                let query = Security.safeTicker(inputQuery || document.getElementById('tickerInput').value);
                if (!query) return;

                if (AppState.portfolio.find(p => p.ticker === query)) {
                    uiManager.showToast("ì´ë¯¸ ì¶”ê°€ëœ ì¢…ëª©ì…ë‹ˆë‹¤.");
                    document.getElementById('tickerInput').value = '';
                    return;
                }

                uiManager.toggleLoading(true, "ë°ì´í„° ë³´ì•ˆ ë¶„ì„ ì¤‘...");

                try {
                    let chartData = null;
                    let targetTicker = query;

                    if (/^\d{6}$/.test(query)) {
                        targetTicker = query + ".KS";
                        chartData = await networkManager.getChartData(targetTicker);
                        if (!chartData) {
                            targetTicker = query + ".KQ";
                            chartData = await networkManager.getChartData(targetTicker);
                        }
                    } else {
                        chartData = await networkManager.getChartData(targetTicker);
                    }

                    if (!chartData) throw new Error("Not Found");

                    const meta = chartData.meta;
                    const quotes = chartData.indicators.quote[0].close;
                    const price = meta.regularMarketPrice;
                    const currency = meta.currency;
                    
                    const isIsa = currency === 'KRW' || targetTicker.endsWith('.KS') || targetTicker.endsWith('.KQ');

                    let cagr = 5.0;
                    const startPrice = quotes.find(p => p != null);
                    if (startPrice && price) {
                        const years = (meta.regularMarketTime - chartData.timestamp[0]) / (3600*24*365);
                        if(years > 0.5) cagr = ((Math.pow(price / startPrice, 1/years) - 1) * 100);
                    }

                    let divYield = 0;
                    if (chartData.events && chartData.events.dividends) {
                        const divs = Object.values(chartData.events.dividends);
                        const oneYearAgo = Date.now()/1000 - 31536000;
                        const totalDiv = divs.filter(d => d.date > oneYearAgo).reduce((a,b) => a + b.amount, 0);
                        if(price > 0) divYield = (totalDiv / price) * 100;
                    }

                    AppState.portfolio.push({
                        ticker: targetTicker,
                        price: price,
                        currency: currency,
                        isIsa: isIsa,
                        cagr: parseFloat(cagr.toFixed(2)),
                        yield: parseFloat(divYield.toFixed(2)),
                        allocation: 0
                    });

                    uiManager.updateAll();
                    dataManager.save();
                    document.getElementById('tickerInput').value = '';

                } catch (e) {
                    uiManager.showToast("ì¢…ëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                } finally {
                    uiManager.toggleLoading(false);
                }
            },

            autoComplete: async (val) => {
                const box = document.getElementById('suggestionBox');
                if (val.length < 1) { box.classList.add('hidden'); return; }
                
                const quotes = await networkManager.searchSymbol(val);
                const valid = quotes.filter(q => ['ETF','EQUITY','MUTUALFUND'].includes(q.quoteType));
                
                box.innerHTML = '';
                if (valid.length === 0) { box.classList.add('hidden'); return; }

                valid.forEach(q => {
                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-slate-50 cursor-pointer border-b last:border-0";
                    
                    const isKRW = q.symbol.endsWith('.KS') || q.symbol.endsWith('.KQ');
                    const badge = isKRW ? '<span class="text-[10px] bg-green-100 text-green-700 px-1 rounded ml-1">ISA</span>' : '';
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold text-blue-700 mr-1">${Security.sanitize(q.symbol)}</span>${badge}
                                <span class="text-xs text-slate-500 truncate inline-block align-bottom max-w-[150px]">${Security.sanitize(q.shortname || q.longname)}</span>
                            </div>
                        </div>`;
                    
                    div.onclick = (e) => {
                        e.stopPropagation();
                        document.getElementById('tickerInput').value = q.symbol;
                        uiManager.closeSuggestions();
                        logicManager.addTicker(q.symbol);
                    };
                    box.appendChild(div);
                });
                box.classList.remove('hidden');
            }
        };

        const simulationManager = {
            run: () => {
                const amtStr = Security.onlyNumber(document.getElementById('inputAmount').value);
                const monthlyAmt = parseInt(amtStr) || 0;
                const years = parseInt(document.getElementById('inputYears').value);
                const reinvest = document.getElementById('reinvest').checked;

                const totalAlloc = AppState.portfolio.reduce((sum, i) => sum + (i.allocation||0), 0);
                if (totalAlloc !== 100) return alert(`ë¹„ì¤‘ í•©ê³„ëŠ” 100%ì—¬ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${totalAlloc}%)`);
                if (monthlyAmt <= 0) return alert("íˆ¬ì ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                let wCagr = 0, wYield = 0;
                AppState.portfolio.forEach(p => {
                    wCagr += p.cagr * (p.allocation/100);
                    wYield += p.yield * (p.allocation/100);
                });

                const months = years * 12;
                const mGrowth = wCagr / 100 / 12;
                const mDiv = wYield / 100 / 12;

                let principal = 0, balance = 0, totalDiv = 0, cash = 0;
                const labels = [], dPrin = [], dBal = [];

                for(let i=1; i<=months; i++) {
                    principal += monthlyAmt;
                    balance += monthlyAmt;
                    balance *= (1 + mGrowth);
                    
                    let div = balance * mDiv;
                    totalDiv += div;

                    if(reinvest) balance += div;
                    else cash += div;

                    if(i % 12 === 0) {
                        labels.push((i/12)+"ë…„");
                        dPrin.push(principal);
                        dBal.push(Math.round(reinvest ? balance : balance + cash));
                    }
                }

                const final = Math.round(reinvest ? balance : balance + cash);
                const roi = ((final - principal) / principal) * 100;

                document.getElementById('resPrincipal').textContent = uiManager.formatMoney(principal);
                document.getElementById('resDividend').textContent = uiManager.formatMoney(totalDiv);
                document.getElementById('resFinal').textContent = uiManager.formatMoney(final);
                document.getElementById('resRoi').textContent = (roi > 0 ? '+' : '') + roi.toFixed(1) + '%';

                simulationManager.drawChart(labels, dPrin, dBal);
            },

            drawChart: (labels, d1, d2) => {
                const ctx = document.getElementById('chart').getContext('2d');
                if (AppState.chartInstance) AppState.chartInstance.destroy();

                AppState.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'ì›ê¸ˆ', data: d1, borderColor: '#94a3b8', backgroundColor: 'rgba(148,163,184,0.1)', fill: true, borderWidth: 2, pointRadius: 0 },
                            { label: 'ì˜ˆìƒ ìì‚°', data: d2, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true, borderWidth: 2, pointRadius: 3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { tooltip: { backgroundColor: 'rgba(255,255,255,0.95)', titleColor:'#1e293b', bodyColor:'#334155', borderColor:'#e2e8f0', borderWidth:1, padding:10 } },
                        scales: { x: { grid: { display: false } }, y: { grid: { borderDash: [2,4] }, ticks: { callback: v => (v/100000000).toFixed(1)+'ì–µ' } } }
                    }
                });
            }
        };

        // --- Event Listeners ---
        let debounceTimer;
        document.getElementById('tickerInput').addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => logicManager.autoComplete(e.target.value.toUpperCase()), 300);
        });
        
        document.getElementById('tickerInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                uiManager.closeSuggestions();
                logicManager.addTicker();
            }
        });

        document.getElementById('addBtn').addEventListener('click', () => {
            uiManager.closeSuggestions();
            logicManager.addTicker();
        });

        document.getElementById('inputAmount').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            dataManager.save();
            uiManager.updateAll();
        });

        document.getElementById('inputYears').addEventListener('input', (e) => {
            dataManager.save();
            uiManager.updateAll();
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', dataManager.load);

    </script>
</body>
</html>
