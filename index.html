<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 1. ê²€ìƒ‰ ì—”ì§„ ìµœì í™” (SEO) í•µì‹¬ íƒœê·¸ -->
    <title>ETF ìˆ˜ìµë¥  ê³„ì‚°ê¸° & ë°°ë‹¹ ì¬íˆ¬ì ì‹œë®¬ë ˆì´í„° (ë¯¸êµ­ì£¼ì‹/ISA ì§€ì›)</title>
    <meta name="title" content="ETF ìˆ˜ìµë¥  ê³„ì‚°ê¸° & ë°°ë‹¹ ì¬íˆ¬ì ì‹œë®¬ë ˆì´í„° (ë¯¸êµ­ì£¼ì‹/ISA ì§€ì›)">
    <meta name="description" content="ë§¤ì›” ì ë¦½ì‹ íˆ¬ì ì‹œ 10ë…„ ë’¤ ìì‚°ì€? ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™. ë¯¸êµ­ ì£¼ì‹(SPY, SCHD, QQQ) ë° í•œêµ­ ISA ê³„ì¢Œ ETFì˜ ë³µë¦¬ ìˆ˜ìµë¥ ê³¼ ë°°ë‹¹ê¸ˆì„ ìë™ìœ¼ë¡œ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤. ì—‘ì…€ ì—†ì´ ê°„í¸í•˜ê²Œ ì‹œë®¬ë ˆì´ì…˜í•˜ì„¸ìš”.">
    <meta name="keywords" content="ETF ê³„ì‚°ê¸°, ë³µë¦¬ ê³„ì‚°ê¸°, ë°°ë‹¹ê¸ˆ ì¬íˆ¬ì, ë¯¸êµ­ ì£¼ì‹, ì ë¦½ì‹ íˆ¬ì, ISA ê³„ì¢Œ, ì£¼ì‹ ì‹œë®¬ë ˆì´ì…˜, SPY, QQQ, SCHD, ë°°ë‹¹ ì„±ì¥, íŒŒì´ì–´ì¡±, ì¬í…Œí¬, ê¸ˆìœµ ê³„ì‚°ê¸°, TIGER ë¯¸êµ­í…Œí¬TOP10">
    <meta name="author" content="ETF Auto Simulator">
    <meta name="robots" content="index, follow">
    
    <!-- 2. SNS ê³µìœ  ìµœì í™” (Open Graph) - ì¹´í†¡/í˜ì´ìŠ¤ë¶ ê³µìœ  ì‹œ ë³´ì´ëŠ” ë‚´ìš© -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-website-url.com/"> <!-- ì‹¤ì œ ë°°í¬ ì£¼ì†Œë¡œ ë³€ê²½ ê¶Œì¥ -->
    <meta property="og:title" content="ë‚´ ETF í¬íŠ¸í´ë¦¬ì˜¤ì˜ ë¯¸ë˜ëŠ”? | ì´ˆê°„ë‹¨ ìˆ˜ìµë¥  ê³„ì‚°ê¸°">
    <meta property="og:description" content="ë³µì¡í•œ ì—‘ì…€ì€ ê·¸ë§Œ! ì¢…ëª©ë§Œ ê²€ìƒ‰í•˜ë©´ ê³¼ê±° ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë¯¸ë˜ ìˆ˜ìµê³¼ ë°°ë‹¹ê¸ˆì„ ìë™ìœ¼ë¡œ ê³„ì‚°í•´ì¤ë‹ˆë‹¤. ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”.">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/2422/2422796.png"> <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì£¼ì†Œ -->
    <meta property="og:site_name" content="ETF Auto Simulator">
    <meta property="og:locale" content="ko_KR">

    <!-- 3. íŠ¸ìœ„í„° ì¹´ë“œ (Twitter Card) -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-website-url.com/">
    <meta property="twitter:title" content="ETF ì ë¦½ì‹ íˆ¬ì ë³µë¦¬ ê³„ì‚°ê¸°">
    <meta property="twitter:description" content="ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ ETF ì‹œë®¬ë ˆì´í„°. ë°°ë‹¹ ì¬íˆ¬ì íš¨ê³¼ë¥¼ ëˆˆìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.">
    <meta property="twitter:image" content="https://cdn-icons-png.flaticon.com/512/2422/2422796.png">

    <!-- 4. ì›¹ë§ˆìŠ¤í„° ë„êµ¬ ì¸ì¦ (êµ¬ê¸€/ë„¤ì´ë²„ ì„œì¹˜ì½˜ì†” ë“±ë¡ ì‹œ contentì— ì½”ë“œ ì…ë ¥) -->
    <meta name="google-site-verification" content="êµ¬ê¸€_ì„œì¹˜ì½˜ì†”_ì¸ì¦ì½”ë“œ_ì…ë ¥" />
    <meta name="naver-site-verification" content="ë„¤ì´ë²„_ì›¹ë§ˆìŠ¤í„°ë„êµ¬_ì¸ì¦ì½”ë“œ_ì…ë ¥" />
    
    <!-- 5. êµ¬ì¡°í™”ëœ ë°ì´í„° (JSON-LD) - êµ¬ê¸€ì´ 'ì†Œí”„íŠ¸ì›¨ì–´ ì•±'ìœ¼ë¡œ ì¸ì‹í•˜ê²Œ í•¨ -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "ETF Auto Simulator",
      "url": "https://your-website-url.com/",
      "description": "ë¯¸êµ­ ë° í•œêµ­ ETFì˜ ì ë¦½ì‹ íˆ¬ì ìˆ˜ìµë¥ ê³¼ ë°°ë‹¹ê¸ˆì„ ê³„ì‚°í•´ì£¼ëŠ” ì›¹ ê¸°ë°˜ ê¸ˆìœµ ì‹œë®¬ë ˆì´ì…˜ ë„êµ¬ì…ë‹ˆë‹¤.",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "KRW"
      },
      "featureList": "ì‹¤ì‹œê°„ ì£¼ê°€ ì—°ë™, ë°°ë‹¹ê¸ˆ ì¬íˆ¬ì ê³„ì‚°, ISA ê³„ì¢Œ êµ¬ë¶„, PDF ë¦¬í¬íŠ¸ ì €ì¥"
    }
    </script>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; }
        .ad-area {
            background-color: #f1f5f9;
            border: 2px dashed #cbd5e1;
            display: flex; align-items: center; justify-content: center;
            color: #94a3b8; font-size: 0.8rem; text-align: center; overflow: hidden;
        }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800" onclick="closeSuggestions()">

    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ“ˆ</span>
                <h1 class="text-xl font-bold text-blue-700">ETF Auto Simulator</h1>
                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full font-bold ml-2"></span>
            </div>
            
            <!-- ë°ì´í„° ë°±ì—…/ë³µì› ë²„íŠ¼ -->
            <div class="flex items-center gap-2 text-sm">
                <button onclick="exportData()" class="flex items-center gap-1 bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition">
                    <span>ğŸ“¤</span> ë‚´ë³´ë‚´ê¸°
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-1 bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition">
                    <span>ğŸ“¥</span> ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="importData(this)">
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- [ê´‘ê³ ] ë°°ë„ˆ -->
        <div class="col-span-1 lg:col-span-12">
            <!-- êµ¬ê¸€ ì• ë“œì„¼ìŠ¤ ë°˜ì‘í˜• ê´‘ê³  ì½”ë“œê°€ ë“¤ì–´ê°ˆ ìë¦¬ -->
            <div class="ad-area w-full h-24 rounded-lg">
                Google AdSense Banner Area<br>
                (ë°˜ì‘í˜• ë””ìŠ¤í”Œë ˆì´ ê´‘ê³  ì¶”ì²œ)
            </div>
        </div>

        <!-- ì¢Œì¸¡: ì…ë ¥ ë° ê²€ìƒ‰ íŒ¨ë„ -->
        <div class="col-span-1 lg:col-span-4 space-y-6">
            
            <!-- 1. ì¢…ëª© ê²€ìƒ‰ (í•µì‹¬ ê¸°ëŠ¥) -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative z-40">
                <h2 class="font-bold text-lg mb-4 text-slate-800">ğŸ” ETF/ì£¼ì‹ ì¢…ëª© ê²€ìƒ‰</h2>
                
                <div class="relative">
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="tickerInput" 
                            class="flex-1 p-3 border border-slate-300 rounded-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none uppercase" 
                            placeholder="ì˜ˆ: 360750, SCHD, ì‚¼ì„±ì „ì" autocomplete="off" oninput="handleInput(this.value)" 
                            aria-label="ì¢…ëª© ê²€ìƒ‰ ì…ë ¥ì°½">
                        <button onclick="searchAndAddTicker()" id="addBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-lg font-bold transition whitespace-nowrap">ì¶”ê°€</button>
                    </div>

                    <!-- ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ -->
                    <div id="suggestionBox" class="hidden absolute top-full left-0 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-60 overflow-y-auto mt-1 z-50">
                        <!-- JSë¡œ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="text-xs text-slate-500 mb-4 leading-relaxed bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <p class="font-bold mb-1">ğŸ’¡ ê²€ìƒ‰ ë° ì‚¬ìš© íŒ</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>í•œêµ­ ETF:</strong> 6ìë¦¬ ì½”ë“œ(360750) ì…ë ¥ ì‹œ ì •í™•ë„ UP</li>
                        <li><strong>ë¯¸êµ­ ETF:</strong> í‹°ì»¤(QQQ, SPY) ë˜ëŠ” ì˜ë¬¸ëª… ì…ë ¥</li>
                        <li>ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— <strong>ìë™ ì €ì¥</strong>ë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <!-- ê²€ìƒ‰ëœ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (í¬íŠ¸í´ë¦¬ì˜¤) -->
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-sm text-slate-700">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h3>
                        <span id="totalAlloc" class="text-xs font-bold text-red-500">0%</span>
                    </div>
                    
                    <div id="portfolioList" class="space-y-3 max-h-[300px] overflow-y-auto pr-1 min-h-[50px]">
                        <!-- JSë¡œ ì¶”ê°€ë¨ -->
                    </div>
                    
                    <div id="emptyMsg" class="text-center text-sm text-slate-400 py-8 border-2 border-dashed border-slate-200 rounded-lg mt-2">
                        ìœ„ì—ì„œ ê²€ìƒ‰í•˜ì—¬<br>ì¢…ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                    </div>
                </div>
            </div>

            <!-- 2. íˆ¬ì ì„¤ì • -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-lg mb-4">âš™ï¸ ì ë¦½ì‹ íˆ¬ì ì„¤ì •</h2>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-1" for="inputAmount">ë§¤ë‹¬ íˆ¬ì ê¸ˆì•¡ (ì›” ì ë¦½ì•¡)</label>
                    <input type="text" id="inputAmount" class="w-full p-2 border border-slate-300 rounded text-right font-bold text-lg" value="1,000,000">
                    <div id="koreanMoney" class="text-xs text-blue-600 text-right mt-1">ì¼ë°±ë§Œ ì›</div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-1" for="inputYears">íˆ¬ì ê¸°ê°„: <span id="yearVal" class="text-blue-600">10ë…„</span></label>
                    <input type="range" id="inputYears" min="1" max="30" value="10" class="w-full accent-blue-600">
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-slate-700">ë°°ë‹¹ê¸ˆ ì¬íˆ¬ì (ë³µë¦¬ íš¨ê³¼)</span>
                    <input type="checkbox" id="reinvest" class="w-5 h-5 accent-blue-600" checked>
                </div>
            </div>

            <button onclick="runSimulation()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                ìˆ˜ìµë¥  ê³„ì‚°í•˜ê¸° ğŸš€
            </button>
        </div>

        <!-- ìš°ì¸¡: ê²°ê³¼ ë¦¬í¬íŠ¸ ì˜ì—­ -->
        <div class="col-span-1 lg:col-span-8 space-y-6" id="reportArea">
            
            <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-2 gap-2">
                <h2 class="text-xl font-bold text-slate-800">ğŸ“Š íˆ¬ì ì‹œë®¬ë ˆì´ì…˜ ë¦¬í¬íŠ¸</h2>
                
                <div class="flex gap-2" data-html2canvas-ignore="true">
                    <button onclick="downloadReport('image')" class="flex items-center gap-1 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm">
                        <span>ğŸ–¼ï¸</span> ì´ë¯¸ì§€ ì €ì¥
                    </button>
                    <button onclick="downloadReport('pdf')" class="flex items-center gap-1 bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm">
                        <span>ğŸ“„</span> PDF ì €ì¥
                    </button>
                </div>
            </div>

            <!-- ìš”ì•½ ì¹´ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-xl border-l-4 border-slate-400 shadow-sm">
                    <p class="text-xs text-slate-500 mb-1">ì´ íˆ¬ì ì›ê¸ˆ</p>
                    <p id="resPrincipal" class="text-2xl font-bold text-slate-700">0ì›</p>
                </div>
                <div class="bg-white p-5 rounded-xl border-l-4 border-green-500 shadow-sm">
                    <p class="text-xs text-slate-500 mb-1">ëˆ„ì  ì˜ˆìƒ ë°°ë‹¹ê¸ˆ</p>
                    <p id="resDividend" class="text-2xl font-bold text-green-600">0ì›</p>
                </div>
                <div class="bg-white p-5 rounded-xl border-l-4 border-blue-600 shadow-sm">
                    <p class="text-xs text-slate-500 mb-1">ìµœì¢… í‰ê°€ ìì‚°</p>
                    <p id="resFinal" class="text-2xl font-bold text-blue-600">0ì›</p>
                    <p id="resRoi" class="text-sm font-bold text-blue-400 mt-1">+0%</p>
                </div>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-80 lg:h-96 relative">
                 <canvas id="chart"></canvas>
            </div>

            <!-- ë°ì´í„° í…Œì´ë¸” -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-slate-700 mb-4">ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± ë° ìƒì„¸ ë°ì´í„°</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="bg-slate-100 text-xs uppercase">
                            <tr>
                                <th class="px-4 py-2">ì¢…ëª©ëª…</th>
                                <th class="px-4 py-2">í˜„ì¬ê°€</th>
                                <th class="px-4 py-2">ê³„ì¢Œêµ¬ë¶„</th>
                                <th class="px-4 py-2">ê³¼ê±°ì„±ì¥ë¥ (5Y)</th>
                                <th class="px-4 py-2">ë°°ë‹¹ë¥ </th>
                                <th class="px-4 py-2" data-html2canvas-ignore="true">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- ë°ì´í„° -->
                        </tbody>
                    </table>
                </div>
            </div>
            
             <!-- [ê´‘ê³ ] í•˜ë‹¨ -->
            <div class="ad-area w-full h-24 rounded-lg" data-html2canvas-ignore="true">
                Google AdSense In-feed Ad Area<br>
                (ì¸í”¼ë“œ ê´‘ê³  ì¶”ì²œ)
            </div>
            
            <div class="text-center text-xs text-slate-400 mt-4 pb-4">
                Generated by ETF Auto Simulator â€¢ ì´ ì‹œë®¬ë ˆì´ì…˜ì€ ê³¼ê±° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì˜ˆì¸¡ì¹˜ì´ë©°, ë¯¸ë˜ì˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
        </div>
    </main>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl flex flex-col items-center animate-bounce-in shadow-2xl">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
            <p class="font-bold text-slate-700 text-lg" id="loadingTitle">ì²˜ë¦¬ ì¤‘...</p>
            <p class="text-sm text-slate-500 mt-1" id="loadingText">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (ì €ì¥/ë¡œë“œ ì•Œë¦¼ìš©) -->
    <div id="toast" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-[70] transition-opacity duration-300 opacity-0">
        ë©”ì‹œì§€ ë‚´ìš©
    </div>

    <script>
        const PROXY_BASE = "https://corsproxy.io/?"; 
        
        let portfolio = []; 
        let myChart = null;
        let searchTimeout = null; 

        // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ ---
        const STORAGE_KEY = 'etf_sim_data_v1';

        // --- ì´ˆê¸°í™”: í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
        window.addEventListener('DOMContentLoaded', () => {
            loadFromLocal();
        });

        // --- ë°ì´í„° ì €ì¥/ë¡œë“œ ë¡œì§ ---
        function saveToLocal() {
            const dataToSave = {
                portfolio: portfolio,
                settings: {
                    amount: document.getElementById('inputAmount').value,
                    years: document.getElementById('inputYears').value,
                    reinvest: document.getElementById('reinvest').checked
                },
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }

        function loadFromLocal() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.portfolio) {
                        portfolio = parsed.portfolio;
                        updatePortfolioUI();
                    }
                    if (parsed.settings) {
                        document.getElementById('inputAmount').value = parsed.settings.amount || "1,000,000";
                        document.getElementById('inputYears').value = parsed.settings.years || 10;
                        document.getElementById('reinvest').checked = parsed.settings.reinvest !== false;
                        
                        const amtInput = document.getElementById('inputAmount');
                        const yearInput = document.getElementById('inputYears');
                        
                        const val = amtInput.value.replace(/[^0-9]/g,'');
                        document.getElementById('koreanMoney').innerText = numToKor(parseMoney(val));
                        document.getElementById('yearVal').innerText = yearInput.value + "ë…„";
                    }
                    if (portfolio.length > 0) {
                        setTimeout(runSimulation, 500);
                    }
                } catch (e) {
                    console.error("Load failed", e);
                }
            }
        }

        // --- íŒŒì¼ ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ë¡œì§ ---
        function exportData() {
            const dataToSave = {
                portfolio: portfolio,
                settings: {
                    amount: document.getElementById('inputAmount').value,
                    years: document.getElementById('inputYears').value,
                    reinvest: document.getElementById('reinvest').checked
                },
                exportDate: new Date().toISOString()
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToSave));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "etf_portfolio_backup.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showToast("ë°ì´í„° íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (!parsed.portfolio || !parsed.settings) throw new Error("Invalid file format");

                    portfolio = parsed.portfolio;
                    document.getElementById('inputAmount').value = parsed.settings.amount;
                    document.getElementById('inputYears').value = parsed.settings.years;
                    document.getElementById('reinvest').checked = parsed.settings.reinvest;

                    updatePortfolioUI();
                    const val = parsed.settings.amount.replace(/[^0-9]/g,'');
                    document.getElementById('koreanMoney').innerText = numToKor(parseMoney(val));
                    document.getElementById('yearVal').innerText = parsed.settings.years + "ë…„";
                    
                    saveToLocal();
                    showToast("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    setTimeout(runSimulation, 300);

                } catch (err) {
                    alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        const formatMoney = n => Math.round(n).toLocaleString() + 'ì›';
        const parseMoney = s => parseInt(s.replace(/,/g, '')) || 0;
        
        const numToKor = (num) => {
            if(num===0) return "0ì›";
            const units = ["", "ë§Œ", "ì–µ", "ì¡°"];
            let unitIdx = 0; let result = "";
            while(num > 0) {
                let mod = num % 10000;
                if(mod > 0) result = mod.toLocaleString() + units[unitIdx] + " " + result;
                num = Math.floor(num / 10000);
                unitIdx++;
            }
            return result + "ì›";
        };

        const amtInput = document.getElementById('inputAmount');
        amtInput.addEventListener('input', (e) => {
            const val = e.target.value.replace(/[^0-9]/g,'');
            e.target.value = val ? parseInt(val).toLocaleString() : '';
            document.getElementById('koreanMoney').innerText = numToKor(parseMoney(val));
            saveToLocal();
        });
        
        document.getElementById('inputYears').addEventListener('input', (e)=>{
            document.getElementById('yearVal').innerText = e.target.value + "ë…„";
            saveToLocal();
        });

        document.getElementById('reinvest').addEventListener('change', () => {
            saveToLocal();
        });

        document.getElementById('tickerInput').addEventListener('keypress', (e)=>{
            if(e.key === 'Enter') searchAndAddTicker();
        });

        // --- PDF/ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ---
        async function downloadReport(type) {
            const element = document.getElementById('reportArea');
            const loadingEl = document.getElementById('loading');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingText = document.getElementById('loadingText');

            loadingEl.classList.remove('hidden');
            loadingTitle.innerText = type === 'pdf' ? "PDF ìƒì„± ì¤‘..." : "ì´ë¯¸ì§€ ì €ì¥ ì¤‘...";
            loadingText.innerText = "ë¦¬í¬íŠ¸ë¥¼ ìº¡ì²˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.";

            try {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    logging: false
                });

                const imgData = canvas.toDataURL('image/png');

                if (type === 'image') {
                    const link = document.createElement('a');
                    link.href = imgData;
                    link.download = `ETF_Simulation_Report_${new Date().toISOString().slice(0,10)}.png`;
                    link.click();
                } else if (type === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`ETF_Simulation_Report_${new Date().toISOString().slice(0,10)}.pdf`);
                }

            } catch (error) {
                console.error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", error);
                alert("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // --- 1. ìë™ì™„ì„± ---
        function handleInput(query) {
            clearTimeout(searchTimeout);
            const box = document.getElementById('suggestionBox');
            if(!query || query.length < 1) {
                box.classList.add('hidden');
                return;
            }
            searchTimeout = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        }

        async function fetchSuggestions(query) {
            const searchUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=6&newsCount=0`;
            const proxyUrl = PROXY_BASE + encodeURIComponent(searchUrl);
            try {
                const res = await fetch(proxyUrl);
                const data = await res.json();
                if(data.quotes && data.quotes.length > 0) {
                    renderSuggestions(data.quotes);
                } else {
                    document.getElementById('suggestionBox').classList.add('hidden');
                }
            } catch (err) {
                console.warn("ìë™ì™„ì„± ì‹¤íŒ¨ (ë¬´ì‹œë¨):", err);
            }
        }

        function renderSuggestions(quotes) {
            const box = document.getElementById('suggestionBox');
            box.innerHTML = '';
            const validQuotes = quotes.filter(q => q.quoteType === 'ETF' || q.quoteType === 'EQUITY' || q.quoteType === 'MUTUALFUND');
            if(validQuotes.length === 0) {
                box.classList.add('hidden');
                return;
            }

            validQuotes.forEach(q => {
                const div = document.createElement('div');
                div.className = "p-3 hover:bg-slate-100 cursor-pointer border-b border-slate-100 last:border-0";
                
                const isKRW = q.symbol.endsWith('.KS') || q.symbol.endsWith('.KQ'); 
                const isaBadge = isKRW ? '<span class="text-[10px] bg-green-100 text-green-700 px-1 rounded ml-1 font-bold">ISA</span>' : '';

                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold text-blue-700 mr-2">${q.symbol}</span>${isaBadge}
                            <span class="text-sm text-slate-600 truncate max-w-[180px] inline-block align-bottom">${q.shortname || q.longname || ''}</span>
                        </div>
                        <span class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded">${q.exchDisp || 'US'}</span>
                    </div>
                `;
                div.onclick = (e) => {
                    e.stopPropagation();
                    document.getElementById('tickerInput').value = q.symbol; 
                    closeSuggestions();
                    searchAndAddTicker(q.symbol); 
                };
                box.appendChild(div);
            });
            box.classList.remove('hidden');
        }

        function closeSuggestions() {
            setTimeout(() => {
                document.getElementById('suggestionBox').classList.add('hidden');
            }, 200);
        }

        // --- 2. ë°ì´í„° ì²˜ë¦¬ ---
        async function fetchChartData(ticker) {
            try {
                const chartUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1mo&range=5y`;
                const proxyUrl = PROXY_BASE + encodeURIComponent(chartUrl);
                const res = await fetch(proxyUrl);
                if(!res.ok) return null;
                const data = await res.json();
                if(!data.chart || !data.chart.result || data.chart.result.length === 0) return null;
                return data.chart.result[0];
            } catch(e) {
                console.error("Chart fetch error:", e);
                return null;
            }
        }

        async function fetchFirstSymbol(query) {
            try {
                const searchUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=1`;
                const proxyUrl = PROXY_BASE + encodeURIComponent(searchUrl);
                const res = await fetch(proxyUrl);
                const data = await res.json();
                if(data.quotes && data.quotes.length > 0) {
                    return data.quotes[0].symbol;
                }
                return null;
            } catch(e) { return null; }
        }

        async function searchAndAddTicker(manualTicker = null) {
            let query = manualTicker || document.getElementById('tickerInput').value.trim();
            if(!query) return;

            if(manualTicker && portfolio.find(p => p.ticker === manualTicker)) {
                alert("ì´ë¯¸ ì¶”ê°€ëœ ì¢…ëª©ì…ë‹ˆë‹¤.");
                document.getElementById('tickerInput').value = '';
                return;
            }

            const loadingEl = document.getElementById('loading');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingText = document.getElementById('loadingText');
            
            loadingEl.classList.remove('hidden');
            loadingTitle.innerText = "ì²˜ë¦¬ ì¤‘...";
            
            try {
                let tickerToFetch = "";
                let chartResult = null;
                
                if (manualTicker) {
                    tickerToFetch = manualTicker;
                    loadingText.innerText = `'${tickerToFetch}' ë°ì´í„° ë¡œë”© ì¤‘...`;
                    chartResult = await fetchChartData(tickerToFetch);
                } else {
                    if (/^\d{6}$/.test(query)) {
                        loadingText.innerText = `'${query}' í•œêµ­ ì¢…ëª©ì½”ë“œ í™•ì¸ ì¤‘...`;
                        let testTicker = query + ".KS";
                        let testResult = await fetchChartData(testTicker);
                        if (!testResult) {
                            testTicker = query + ".KQ";
                            testResult = await fetchChartData(testTicker);
                        }
                        if (testResult) {
                            tickerToFetch = testTicker;
                            chartResult = testResult;
                        }
                    }

                    if (!chartResult) {
                        loadingText.innerText = `'${query}' ì¢…ëª© ì°¾ëŠ” ì¤‘...`;
                        const foundSymbol = await fetchFirstSymbol(query);
                        if (foundSymbol) {
                            tickerToFetch = foundSymbol;
                            loadingText.innerText = `'${tickerToFetch}' ë°ì´í„° ë¡œë”© ì¤‘...`;
                            chartResult = await fetchChartData(tickerToFetch);
                        } else {
                            tickerToFetch = query.toUpperCase();
                            loadingText.innerText = `'${tickerToFetch}' ë°ì´í„° í™•ì¸ ì¤‘...`;
                            chartResult = await fetchChartData(tickerToFetch);
                        }
                    }
                }

                if(!chartResult) throw new Error("Data Not Found");

                if(portfolio.find(p => p.ticker === tickerToFetch)) {
                    alert(`'${tickerToFetch}'ëŠ” ì´ë¯¸ í¬íŠ¸í´ë¦¬ì˜¤ì— ìˆìŠµë‹ˆë‹¤.`);
                    document.getElementById('tickerInput').value = '';
                    loadingEl.classList.add('hidden');
                    return;
                }

                const meta = chartResult.meta;
                const quotes = chartResult.indicators.quote[0].close;
                const currentPrice = meta.regularMarketPrice;
                const currency = meta.currency; 

                let isIsaEligible = false;
                if (currency === 'KRW' || tickerToFetch.endsWith('.KS') || tickerToFetch.endsWith('.KQ')) {
                    isIsaEligible = true;
                }

                let cagr = 0;
                let startPrice = quotes.find(p => p !== null && p !== undefined); 
                let endPrice = currentPrice;
                
                const startTimestamp = chartResult.timestamp[0];
                const endTimestamp = chartResult.timestamp[chartResult.timestamp.length-1];
                const yearDiff = (endTimestamp - startTimestamp) / (3600*24*365);
                
                if(startPrice && yearDiff > 0.5) {
                    cagr = (Math.pow(endPrice / startPrice, 1/yearDiff) - 1) * 100;
                } else {
                    cagr = 5.0; 
                }

                let divYield = 0;
                if(chartResult.events && chartResult.events.dividends) {
                    const divs = chartResult.events.dividends;
                    const oneYearAgo = Date.now()/1000 - 31536000;
                    let totalDiv = 0;
                    for(let key in divs) {
                        if(divs[key].date > oneYearAgo) totalDiv += divs[key].amount;
                    }
                    divYield = (totalDiv / currentPrice) * 100;
                }
                
                portfolio.push({
                    ticker: tickerToFetch,
                    name: query, 
                    price: currentPrice,
                    currency: currency,
                    isIsa: isIsaEligible,
                    cagr: cagr.toFixed(2),
                    yield: divYield.toFixed(2),
                    allocation: 0 
                });

                updatePortfolioUI();
                saveToLocal();
                document.getElementById('tickerInput').value = ''; 

            } catch (err) {
                console.error(err);
                alert(`'${query}' ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì •í™•í•œ ì¢…ëª©ì½”ë“œ(6ìë¦¬)ë‚˜ ì˜ì–´ í‹°ì»¤ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.`);
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // --- 3. UI ì—…ë°ì´íŠ¸ ---
        function updatePortfolioUI() {
            const list = document.getElementById('portfolioList');
            const tbody = document.getElementById('dataTableBody');
            const emptyMsg = document.getElementById('emptyMsg');
            
            list.innerHTML = '';
            tbody.innerHTML = '';
            
            if(portfolio.length === 0) {
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
            }

            let totalAlloc = 0;

            portfolio.forEach((item, index) => {
                const isaBadge = item.isIsa 
                    ? `<span class="text-[10px] bg-green-100 text-green-700 font-bold px-1.5 py-0.5 rounded border border-green-200">ISA ê°€ëŠ¥</span>`
                    : `<span class="text-[10px] bg-slate-100 text-slate-500 font-bold px-1.5 py-0.5 rounded border border-slate-200">ISA ë¶ˆê°€ (ì§íˆ¬)</span>`;

                const div = document.createElement('div');
                div.className = "flex items-center gap-2 bg-slate-50 p-3 rounded-lg border border-slate-200 fade-in shadow-sm";
                div.innerHTML = `
                    <div class="flex-1 overflow-hidden">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-slate-800">${item.ticker}</span>
                            ${isaBadge}
                        </div>
                        <div class="text-xs text-slate-500">
                            ì„±ì¥ <span class="text-blue-600 font-bold">${item.cagr}%</span> / 
                            ë°°ë‹¹ <span class="text-green-600 font-bold">${item.yield}%</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="flex items-center gap-1">
                            <input type="number" class="w-16 p-1.5 text-right text-sm border border-slate-300 rounded focus:border-blue-500 outline-none font-bold" 
                                value="${item.allocation}" data-idx="${index}" onchange="updateAlloc(${index}, this.value)">
                            <span class="text-sm text-slate-500">%</span>
                        </div>
                    </div>
                    <button onclick="removeTicker(${index})" class="text-slate-400 hover:text-red-500 p-1 ml-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                list.appendChild(div);
                totalAlloc += parseInt(item.allocation) || 0;

                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition-colors";
                const currencySymbol = item.currency === 'KRW' ? 'â‚©' : '$';
                
                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-bold text-slate-700">${item.ticker}</div>
                        <div class="text-xs text-slate-400">${item.currency}</div>
                    </td>
                    <td class="px-4 py-3 text-slate-600">
                        ${currencySymbol}${item.price ? item.price.toLocaleString(undefined, {maximumFractionDigits: 2}) : '-'}
                    </td>
                    <td class="px-4 py-3">${isaBadge}</td>
                    <td class="px-4 py-3 text-blue-600 font-bold bg-blue-50/50">${item.cagr}%</td>
                    <td class="px-4 py-3 text-green-600 font-bold bg-green-50/50">${item.yield}%</td>
                    <td class="px-4 py-3" data-html2canvas-ignore="true">
                         <button onclick="removeTicker(${index})" class="text-xs bg-white border border-red-200 text-red-500 px-3 py-1.5 rounded hover:bg-red-50 transition">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const allocSpan = document.getElementById('totalAlloc');
            allocSpan.innerText = totalAlloc + '%';
            if(totalAlloc === 100) {
                allocSpan.className = "text-xs font-bold text-white bg-green-500 px-2 py-0.5 rounded-full";
            } else {
                allocSpan.className = "text-xs font-bold text-white bg-red-500 px-2 py-0.5 rounded-full";
            }
        }

        function updateAlloc(index, val) {
            let v = parseInt(val) || 0;
            if(v < 0) v = 0;
            if(v > 100) v = 100;
            portfolio[index].allocation = v;
            updatePortfolioUI();
            saveToLocal();
        }

        function removeTicker(index) {
            portfolio.splice(index, 1);
            updatePortfolioUI();
            saveToLocal();
        }

        // --- 4. ì‹œë®¬ë ˆì´ì…˜ ê³„ì‚° ---
        function runSimulation() {
            const monthlyAmt = parseMoney(amtInput.value);
            const years = parseInt(document.getElementById('inputYears').value);
            const reinvest = document.getElementById('reinvest').checked;

            const totalAlloc = portfolio.reduce((sum, item) => sum + (parseInt(item.allocation)||0), 0);
            if(totalAlloc !== 100) {
                alert(`ë¹„ì¤‘ì˜ í•©ì€ 100%ì—¬ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${totalAlloc}%)`);
                return;
            }
            if(monthlyAmt <= 0) {
                alert("íˆ¬ì ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            let wCAGR = 0;
            let wYield = 0;
            portfolio.forEach(p => {
                const weight = p.allocation / 100;
                wCAGR += parseFloat(p.cagr) * weight;
                wYield += parseFloat(p.yield) * weight;
            });

            const months = years * 12;
            const monthlyGrowth = wCAGR / 100 / 12;
            const monthlyDiv = wYield / 100 / 12;

            let principal = 0;
            let balance = 0;
            let totalDivReceived = 0;
            let cashPocket = 0;

            let labels = [];
            let dataPrin = [];
            let dataBal = [];

            for(let i=1; i<=months; i++) {
                principal += monthlyAmt;
                balance += monthlyAmt;
                balance = balance * (1 + monthlyGrowth);
                
                let div = balance * monthlyDiv;
                totalDivReceived += div;

                if(reinvest) {
                    balance += div;
                } else {
                    cashPocket += div;
                }

                if(i%12 === 0) {
                    labels.push((i/12) + "ë…„");
                    dataPrin.push(principal);
                    dataBal.push(Math.round(reinvest ? balance : balance + cashPocket));
                }
            }

            const finalVal = reinvest ? balance : balance + cashPocket;
            const profit = finalVal - principal;
            const roi = (profit / principal) * 100;

            document.getElementById('resPrincipal').innerText = formatMoney(principal);
            document.getElementById('resDividend').innerText = formatMoney(totalDivReceived);
            document.getElementById('resFinal').innerText = formatMoney(finalVal);
            document.getElementById('resRoi').innerText = (roi>0?"+":"") + roi.toFixed(1) + "%";

            drawChart(labels, dataPrin, dataBal);
        }

        function drawChart(labels, d1, d2) {
            const ctx = document.getElementById('chart').getContext('2d');
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ìˆœìˆ˜ ì›ê¸ˆ',
                            data: d1,
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(148, 163, 184, 0.1)',
                            fill: true,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'ì˜ˆìƒ í‰ê°€ì•¡',
                            data: d2,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            pointRadius: 3,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1e293b',
                            bodyColor: '#334155',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: (ctx) => ctx.dataset.label + ": " + ctx.raw.toLocaleString() + "ì›"
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { 
                            grid: { borderDash: [2, 4] },
                            ticks: { callback: (val) => (val/100000000).toFixed(1) + 'ì–µ' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>